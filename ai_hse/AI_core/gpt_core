from django.shortcuts import render
from openai import OpenAI
import os
from dotenv import load_dotenv

load_dotenv()
Groq_token = os.getenv('GROQ_TOKEN')


def main_page(request):
    generated_text = None

    if request.method == "POST":
        TA_age = request.POST.get("TA_age")
        TA_income = request.POST.get("TA_income")
        TA_interests = request.POST.get("TA_interests")
        TA_social_status = request.POST.get("TA_social_status")
        TA_gender = request.POST.get("TA_gender")
        TA_education = request.POST.get("TA_education")
        communication_type = request.POST.get("communication_type")
        communication_purpose = request.POST.get("communication_purpose")

        promt = f'''
            Ты — опытный копирайтер и CRM-специалист с более чем 10-летним опытом в крупной компании. Ты эксперт и мастерски создаешь персонализированные, цепляющие и конверсионные тексты для разных каналов коммуникации. Ты отлично знаешь психологию потребителя, умеешь работать с целевой аудиторией и адаптировать тон, длину и призыв к действию под конкретный канал.
Задача: Напиши текст для маркетинговой коммуникации на основе предоставленных данных.
Входные данные:
Тип коммуникации: {communication_type}
Цель коммуникации, что хотим сказать пользователю: {communication_purpose}
Гипотеза эксперимента: [например: предлагать баерам , которые успешно нашли своего репетитора, найти репетитора в другой категории. Предполагаем, что, если мы им напомним, они совершат байерский контакт]
Статус пользователя: {TA_social_status}
Целевая аудитория (Target Audience):
Возраст: {TA_age}
Пол: {TA_gender}
Доход: {TA_income}
Интересы: {TA_interests}
Социальный статус: {TA_social_status}
Образование: {TA_education}
Дополнительная информация о пользователе: {extra_info}
Имя: {user_name}

Важные инструкции:
Адаптация под канал: Учти особенности канала коммуникации.
Email: Заголовок до 30 символов без пробелов, основной текст до 300 символов без пробелов 
App-Push / Web-Push: Заголовок до 20 символов без пробелов. Основной текст до 100 символов без пробелов. Яркий, побуждающий к мгновенному действию текст. Указывай эмодзи для привлечения внимания.
Работа с данными ЦА: Тщательно проанализируй предоставленные данные о целевой аудитории. Используй их для тона, аргументации и выбора бенефитов.
Если какой-либо параметр ЦА отсутствует или не указан, сделай текст более универсальным, сфокусировавшись на цели коммуникации и базовых триггерах (выгода, ограниченность предложения, любопытство).
Структура и элементы:
Заголовок: Цепляющий, интригующий или прямо говорящий о выгоде.
Основной текст: Раскрывает ценность предложения для конкретной ЦА. 
Призыв к действию (CTA): Четкий, понятный и побудительный (например, "Получить скидку", "Забрать товар", "Узнать первым").
Дедлайн/Условие (если уместно): Создай ощущение срочности или эксклюзивности (например, "только до конца недели", "только для вас").
Тон и стиль: Тон должен соответствовать ЦА. Для молодежи — более неформальный и динамичный, для старшей аудитории с высоким доходом — уважительный и сдержанный, подчеркивающий статус и качество.
Формат вывода (Output Format):
Предоставь ответ в виде чистого, готового к использованию текста. Не объясняй свои решения и не добавляй мета-комментарии. Просто выдай финальный текст, готовый к отправке. Не задавай уточняющих вопросов, работай только с представленной информацией. 
        '''

        client = OpenAI(
            base_url="https://api.groq.com/openai/v1",
            api_key=Groq_token
        )

        response = client.responses.create(
            model="openai/gpt-oss-20b",
            input=prompt
        )

        generated_text = response.output_text

    return render(request, "main_page.html", {"result": generated_text})
